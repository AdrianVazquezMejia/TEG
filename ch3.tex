\section{Documentar el funcionamiento de las redes WiFi malladas}

\section{Diseño de una red mallada basada en el microcontrolador ESP32}

La red mallada se diseño para una sola red Modbus, por lo que, solo puede existir un maestro y una cantidad de XXX esclavos (Citacion required). Teniendo en consideración lo anterior, se definió la topología de la red mallada; las rutas de comunicación se determinan según el esclavo que el maestro Modbus esté interrogando. Así, aunque las rutas sean estáticas, el enrutamiento de cada nodo variaría según una tabla de enrutamiento determinada. 

Por otro lado, existen otras características  de comunicación, como lo es el estándar del bus serial y la características del mismo. Ya que se usa el estándar RS-485, quedaba por definir la tasa de transmisión. Esta  variar, por lo que el nodo es configurable y compatible para las tasas de Baudios siguientes: 

Entonces, quedando diferenciadas las dos etapas (la inalambrica y la serial) y además, se consideraron los dos sentidos de la información (desde y hacia el esclavo), para establecer una lógica para el funcionamiento del nodo. 

Cada nodo contemplaron dos sentidos, el primero es si se le introduce la información por el bus serial entonces esta debe transmitirse inalambricamente; y si recibe información inalambricamente entonces debe pasarla a su bus serial o bien debe trasnmitirla a otro nodo.

Cada  nodo debe ser configurable respecto a su identificador, tabla de enrutamiento y  tasa de baudios de la interfaz serial, para así adaptarlos a los entornos de comunicación industriales. Sabiendo que se transmite el protocolo Modbus entoinces se consideró conveniente considerar a los nodos como esclavos en el sistema. Se reservaron identificadores para los nodos, lo que deja menos cantidad de identificadores de esclavos disponibles para la red en la que se implemente la red mallada.

La comunicación entre los nodos es unicast para así aprovechar las ventajas que esto implica como lo son encriptación, respuesta de agradecimiento y ahorro de (sobrecarga). Para tener mayor cobertura, los esclavos pueden estar a mas de un nodo intermedio del nodo que posee el maestro y la red se diseño para poseyera la capacidad de reenviar dicha información  convenientemente.

Definidas estar características de funcionamiento, se investigaron las librerías que el microcontrolador ESP32 poseía para hacer tales funciones. Se encontraros dos tipos de redes WiFi descritos por Espressif: mesh y espnow. Para elegir cual usar se tomó en cuenta la flexibilidad, descentralización, seguridad y alcance; pues bien son las cualidades que entraban en concordancia para la elaboración de la arquitectura de red anteriormente descrita.

\section{Implementar el módulo del programa para el manejo del protocolo Modbus en el bus RS-485.}

Como se  trabajó en en microcontrolador ESP32, los programas elaborados son administrados por un sistema operativo en tiempo real (RTOS). Al mismo tiempo, el diseño de los programas contempló todas las características que un RTOS implica. Esto se traduce en un paradigma de programación basado en tareas, eventos, colas, etc.

Para manejar el protocoló Modbus en el bus RS-485 se creó una tarea especificamente para la recepción de los datos provenientes del UART conectado al chip MAX485.  Para contemplar los casos en los que los datos pudiesen estar corrompidos u otra falla en la comunicación serial, la recepción se baso en eventos. Por otro lado se agrego una cola para controlar el estado de la tarea del uart, para que no este activa mientras el bus serial esta ocioso, evitando así que consuma recursos innecesariamente. 

Si los datos son recibidos bien se debe evaluar si la trama es una respuesta, una trama para el nodo en cuestión o si se debe enviar a otro nodo. Es por eso que se agrega un \emph{case} del lenguaje C para ello. La evaluación se baso en la tabla de enrutamiento, pues de allí deriva la lógica asociada a la acción.

Si la trama recibida serialmente se debe enviar a otro nodo inalambricamente entonces los datos recibidos son escritos en una cola que se comunica con la tarea asociada a la transmisión WiFi.

En la dirección opuesta, es decir, cuando la información es transmitia desde el uart, entonces este procesos es realizado desde una instrucción específica en las tareas que esto sea requerido. Por ejemplo, cuando la información recibida mediante WiFi sea para un nodo que este conectado a mi bus serial, en cuyo caso en la misma tarea de recepción inalambrica es llamada la instrucción de escritura hacia el uart.

Otro aspecto que se consideró fue que la tasa de baudios fuese configurable	. Para lograr esto, el la función de configuración del uart se deja como parámetro un valor que está asociado a la tasa de baudios.  Si se recibe la orden para cambiar la velocidad del uart, dicha función del configuración del uart es llamada dandole como parámetro el valor asocidado a la nueva tasa de baudios.

\section{Implementar el programa de la red diseñada que soporte la transmisión del protocolo Modbus}

Para la implementación del programa se diseño una estructura basada en el diseño de la red. Esto quiere decir, que basado tareas que se ejecutan secuencialmente según la información es introducida al nodo. Así para se soporte la transmisión del protocolo Modbus basta enviar en la sección de carga la trama correspondiente. Para lograr esto se debe tener en cuenta que la librería usada requiere que se cubran ciertos parámetros.

La dirección MAC del nodo destino, el buffer de datos y la longitud de la trama son los campos obligatorios. Sin embargo, para la comunicación unicast se necesita que adicionalmente el punto destino este registrado.

Cumplidos estos requisitos el protocolo Modbus es exitosamente  soportado a nivel inalámbrico, sin más limitaciones que las definidas por la distancia entre los nodos.

\section{Diseñar el circuito de un nodo para una red WiFi mallada basada en el microcontrolador ESP32}

El microcontrolador ESP32 no posee periférico de comunicación RS-485 por lo que se le agregó al circuito el chip MAX3485 para obtener dicha capacitad usando el uart. Adicionamente se colocó una resistecia de pull-up en el receptor del uart ya que cuando se está transmitiendo el R0 del MAX3485 se coloca en alta impedancia, dejando el receptor del uart en un comportamiento indeterminado (si no tuviese el pull-up). Cabe recordar el el transmisor del uart en estado ocioso posee nivel lógico alto.

Por su puesto el microcontrolador en su encapsulado WROM-32, la cual se tomó por disponibilidad. Así mismo, se agregaron pin header en los pines necesarios para la programación del microcontraldor por los son el GPIO 0, el enable y los I/O del UART0. 

Considerando que en un ámbito industrial es común tener presente la tensión de 24VDC, entonces se uso para la alimentación un convertidor DC/DC. Con la salida regulada permite que se pueda alimentar desde 24 v a 5 V. En caso de que este disponible solo la tensión de la red, se podría usar una fuente de 120VAC/ 5VDC muy comunes en el mercado.

Para diseñar la topolgía se tomó en cuenta que disposión física de los elementos del circuito en el circuito impreso fuese el más optimo; aprovechando las dos capas y la dispocision de la fuente en la capa  posterior al MCU. 

La capa 1 posee el MCU y el chip MAX485 y, la capa 2 los bloques terminales para la alimentación, la entrada de datos del bus RS-485, los pin header de programación y los de la colocación del chip DC/DC. De esta manera se logra la menor interferencia sobre el areá de antena del MCU. 

Para el trazado de las pistas y vias no se tuvieron más limitación mas que las de área prohibida de lejanía de la antena y las propias de diseño de circuitos impresos.

\section{Implementar la red mallada diseñada.}

\section{Analizar el rendimiento de la red de acuerdo a variaciones en los parámetros de transmisión de datos}
