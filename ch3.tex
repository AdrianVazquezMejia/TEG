\section{Diseño de la red mallada}
 
 Cada red mallada se formó como para que la información del protocolo MODBUS proveniente de esclavos o maestro viaje por ella sin que represente ninguna diferencia respecto a una linea serial, es decir, para los elementos MODBUS es transparente la red. Así, la red se puede instalar para equipos que funcionen sobre la linea serial sin modificación alguna.
 
 El enrutamiento de la red se lleva a cabo a partir del esclavo al que este interrogando el maestro. El maestro esta conectado serialmente a un nodo, este al recibir la información vía serial identifica el esclavo y en consecuencia envía la trama MODBUS a un nodo específico que se encuentra el camino hacia el esclavo en cuestión.  Un nodo al recibir la trama inalambricamente identifica el esclavo en la trama y verifica si debe reenviar la trama a otro nodo, o en su defecto transmitirlo serialmente ya que posee el esclavo MODBUS en dicha interfaz. Luego de generada la respuesta esta es analogamente llevada hasta el maestro.
 
 La red es experta, es decir, conoce de antemano en que nodo se encuentra cada esclavo, lo cual es usado para enrutar los mensajes.
 
%agregar esquema 
 \subsection{Características de los nodos}
 Se realizó el programa para que todos los nodos tuviesen el mismo código, sin importar el rol que posea en la red (maestro, intermedio o final). Se llama nodo maestro a el que posee el maestro conectado, nodo intermedio aquel cuya funcionalidad solo en reenviar datos y nodo final a el que posee esclavos Modbus. Sin embargo, los nodos finales también pueden reenviar datos.
 
 Los nodos en sí soportan el protocolo Modbus para ser interrogados y configurados. Por lo que los se reservaron direcciones para  los nodos, en este caso los identificadores desde 101 a 255.  
 
 Cada nodo se le agregó la posibilidad de ofrecer el servicio de configuración de su identificador Modbus,la tasa de baudios de la interfaz RS-485, y la tabla de enrutamiento. Esto a través del acceso a los registros de retención. Además de la funcionalidad de reinicio y reseteo de fabrica(hardware). %xxx Agregar que otras funcionalidades.
 Las direcciones de los registros con sus funcionalidades se expresan en la tabla \ref{Tabla 1: Espec HR}.
 
 \begin{table}[H]
  \centering
\begin{tabular}{llr}
 \toprule
Dirección & Tipo de registro & Descripción  \\
\midrule
01 & Registros de rentención & Identificador \\
02 & Registros de rentención    &  Tasa de baudios  \\
256-512 & Registros de rentención  & Tabla de enrutamiento\\
0 & Bobina &Reinicio \\
\bottomrule
\end{tabular}
\caption{Tablas primarias de los modelos de datos Modbus}\label{Tabla 1: Espec HR}
\end{table}

Más concretamente, los nodos de la red son esclavos adicionales de la red Modbus.
 %Nodos modbus, configuracion, serial'wifin %limitaciones
 
 \subsection{Características de enrutamiento}
 
 Bien sea que los datos sean recibidos serial o inalambricamente,  las decisiones siguientes se toman en base a tabla de enrutamiento.
 
 La tabla de enrutamiento consisten en un arreglo de 256 casillas, donde la posición está asociada a el esclavo Modbus y el valor en la casilla se relaciona con la ubicación de dicho esclavo. Cabe resaltar que la ubicación a la que se refiere la tabla de enrutamiento no es la posción del esclavo en la red, en su lugar es el siguiente nodo a reenviar los datos para llegar al esclavo en cuestión, es decir, los nodos solo conocen un salto hacia adelante y un salto hacia atrás.

La tabla de enrutamiento se llena  mediante los registros de retención, a partir de la dirección 256, la cual se asocia al esclavo 1. Esta debe ser determinada por el usuario que conoce la posición de los nodos en el área a implementar. 
 
Cuando se recibe un trama, se extrae de la trama el identificador del esclavo, y surgen dos casos: corresponde a un número diferente de cero ó es cero. Si es cero, entonces el nodo no tiene ruta a ese nodo, en caso contrario el número puede corrponder al indentificador del nodo en cuestión o a otro nodo al cual se reenviarán la trama. En caso de que sea el nodo en cuestión entonces ha llegado la trama ha llegado a su destino. 

Un esquema más detallado del enrutamiento se puede apreciar en el esquema de la figura  \ref{Fig 1: ULM enrutamiento}.
 
 %tablas de enrutamiento 
